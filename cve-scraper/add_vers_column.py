import csv
import re

# Define file paths
input_csv = "output/cleaned_cves.csv"
output_csv = "output/with_vers.csv"

# Function to extract version range
def extract_version_range(text):
    if not text:
        return "vers:generic/*"

    version_match = re.search(r'v?(\d+\.\d+(?:\.\d+)*)', text, re.IGNORECASE)
    if version_match:
        version = version_match.group(1)  # Extract only the numeric part
        return f"vers:generic/>{version}"

    return "vers:generic/*"

if __name__ == "__main__":
    # Read input CSV and add the new column
    with open(input_csv, newline='', encoding='utf-8') as csvfile:
        reader = csv.DictReader(csvfile)
        fieldnames = reader.fieldnames + ["vers"]  # Add new column

        rows = []
        for row in reader:
            row["vers"] = extract_version_range(row.get("Dynatrace statement", ""))  # Adjust column name if needed
            rows.append(row)

    # Write updated CSV
    with open(output_csv, mode='w', newline='', encoding='utf-8') as csvfile:
        writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
        writer.writeheader()
        writer.writerows(rows)

    print(f"Updated CSV saved as: {output_csv}")
